
<html><head><base href="/" />
<title>Advanced Research Study Proxy</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  background-color: #1f2937;
  color: #f3f4f6;
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

.panel {
  background: #374151;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.flex {
  display: flex;
  gap: 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

input, textarea, select {
  background: #4b5563;
  color: #f3f4f6;
  border: 1px solid #6b7280;
  border-radius: 4px;
  padding: 8px;
  margin-bottom: 10px;
}

button {
  background: #60a5fa;
  color: #f3f4f6;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease-in-out;
}

button:hover {
  background: #3b82f6;
}

.chart {
  width: 100%;
  height: 300px;
  margin: 20px 0;
}

.error {
  color: #f87171;
  background: #374151;
  border-left: 4px solid #ef4444;
  padding: 10px;
  border-radius: 4px;
  margin: 10px 0;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.loading {
  animation: pulse 1.5s infinite;
}

.experiment-generator {
  background: #374151;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.generated-design {
  background: #374151;
  border-left: 4px solid #60a5fa;
  padding: 15px;
  margin-top: 15px;
  border-radius: 4px;
}

.generating {
  position: relative;
  padding-left: 24px;
}

.generating:before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  width: 16px;
  height: 16px;
  margin-top: -8px;
  border: 2px solid #60a5fa;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.status-updates {
  background: #374151;
  padding: 15px;
  border-radius: 4px;
  margin: 10px 0;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #4b5563;
}

.status-item {
  padding: 5px 0;
  border-bottom: 1px solid #4b5563;
}

.status-item:last-child {
  border-bottom: none;
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #60a5fa;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 10px;
  vertical-align: middle;
}

.results-analysis {
  background: #374151;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.results-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.statistical-tests {
  background: #374151;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.charts-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.charts-container canvas {
  background: #374151;
  border-radius: 8px;
  padding: 10px;
}

.key-finding {
  background: #374151;
  padding: 12px;
  border-radius: 6px;
  border-left: 4px solid #60a5fa;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <h1>Advanced Research Study Proxy</h1>

  <div class="panel experiment-generator">
    <h2>AI Experiment Generator</h2>
    <p>Describe your research goals in natural language and let AI design your experiment</p>
    <textarea id="experimentDescription" rows="4" 
      placeholder="Example: I want to study how different background music affects productivity in remote work environments"></textarea>
    <button onclick="generateExperiment()">Generate Experiment Design</button>
    <div id="generatedDesign"></div>
  </div>

  <div class="panel">
    <h2>Study Configuration</h2>
    <div class="grid">
      <div>
        <label>Study Name</label>
        <input type="text" id="studyName" placeholder="Enter study name">

        <label>Research Question</label>
        <textarea id="researchQuestion" rows="3" placeholder="What is your research question?"></textarea>

        <label>Number of Participants</label>
        <input type="number" id="participantCount" min="1" max="50" value="10">

        <label>Study Type</label>
        <select id="studyType">
          <option value="experimental">Experimental</option>
          <option value="observational">Observational</option>
          <option value="survey">Survey</option>
        </select>
      </div>

      <div>
        <h3>Variables</h3>
        <div id="variables"></div>
        <button onclick="addVariable()">Add Variable</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Participant Profiles</h2>
    <div id="profiles" class="grid"></div>
    <button onclick="generateProfiles()">Generate Profiles</button>
  </div>

  <div class="panel">
    <h2>Experiment Execution</h2>
    <div id="experimentStatus" class="status-updates"></div>
    <button id="conductExperiment" onclick="conductExperiment()">Conduct Experiment</button>
  </div>

  <div class="panel">
    <h2>Results</h2>
    <div id="results">
      <div id="resultsAnalysis" class="results-analysis"></div>
      <div id="resultsSummary" class="results-summary"></div>
      <div id="statisticalTests" class="statistical-tests"></div>
    </div>
    <div class="charts-container">
      <canvas id="resultsChart"></canvas>
      <canvas id="secondaryChart"></canvas>
    </div>
  </div>

  <div class="panel">
    <h2>API Settings</h2>
    <label>Gemini API Key</label>
    <input type="password" id="apiKey" placeholder="Enter your Gemini API key">
    <button onclick="testApiKey()">Test API Key</button>
    <div id="apiKeyStatus"></div>
  </div>
</div>

<script>
// Create database tables
async function initDatabase() {
  await createStudyTable();
  await createParticipantTable();
  await createResultsTable();
}

async function createStudyTable() {
  const query = `CREATE TABLE IF NOT EXISTS study (
    id INTEGER PRIMARY KEY,
    name TEXT,
    question TEXT,
    type TEXT,
    participant_count INTEGER
  )`;
  await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
}

async function createParticipantTable() {
  const query = `CREATE TABLE IF NOT EXISTS participant (
    id INTEGER PRIMARY KEY,
    study_id INTEGER,
    profile TEXT,
    FOREIGN KEY(study_id) REFERENCES study(id)
  )`;
  await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
}

async function createResultsTable() {
  const query = `CREATE TABLE IF NOT EXISTS result (
    id INTEGER PRIMARY KEY,
    participant_id INTEGER,
    variable TEXT,
    value REAL,
    FOREIGN KEY(participant_id) REFERENCES participant(id)
  )`;
  await fetch('/api/v1/sql/?' + new URLSearchParams({sql: query}));
}

// Add variable UI
function addVariable() {
  const variables = document.getElementById('variables');
  const div = document.createElement('div');
  div.innerHTML = `
    <input type="text" placeholder="Variable name" class="variable-name">
    <select class="variable-type">
      <option value="numeric">Numeric</option>
      <option value="categorical">Categorical</option>
    </select>
  `;
  variables.appendChild(div);
}

// Test API Key
async function testApiKey() {
  const apiKey = document.getElementById('apiKey').value;
  const statusEl = document.getElementById('apiKeyStatus');
  
  try {
    const response = await callGeminiApi("Test message", apiKey);
    statusEl.innerHTML = '<span style="color: green">✓ API key is valid</span>';
  } catch (err) {
    statusEl.innerHTML = `<span style="color: red">✗ API key error: ${err.message}</span>`;
  }
}

// Call Gemini API
async function callGeminiApi(prompt, apiKey = null) {
  if (!apiKey) {
    apiKey = document.getElementById('apiKey').value;
  }
  
  if (!apiKey) {
    throw new Error('Please enter an API key');
  }

  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      contents: [{
        parts: [{
          text: prompt
        }]
      }]
    })
  });

  if (!response.ok) {
    throw new Error('API request failed: ' + response.statusText);
  }

  return response.json();
}

// Generate participant profiles using Gemini
async function generateProfiles() {
  const count = document.getElementById('participantCount').value;
  const studyType = document.getElementById('studyType').value;
  
  try {
    const response = await callGeminiApi(`Generate ${count} diverse research participant profiles for a ${studyType} study.
    Format the response as JSON array of profiles with schema:
    {
      "profiles": [{
        "age": number,
        "gender": "string",
        "education": "string",
        "occupation": "string",
        "relevantTraits": ["string"]
      }]
    }`);
    
    const data = JSON.parse(response.candidates[0].content.parts[0].text);
    displayProfiles(data.profiles);
    
  } catch (err) {
    console.error('Error generating profiles:', err);
    document.getElementById('profiles').innerHTML = `
      <div class="error">Error generating profiles: ${err.message}</div>
    `;
  }
}

// Display generated profiles
function displayProfiles(profiles) {
  const container = document.getElementById('profiles');
  container.innerHTML = profiles.map(p => `
    <div class="panel">
      <h3>Participant Profile</h3>
      <p><strong>Age:</strong> ${p.age}</p>
      <p><strong>Gender:</strong> ${p.gender}</p>
      <p><strong>Education:</strong> ${p.education}</p>
      <p><strong>Occupation:</strong> ${p.occupation}</p>
      <p><strong>Traits:</strong> ${p.relevantTraits.join(', ')}</p>
    </div>
  `).join('');
}

// Initialize
window.onload = async function() {
  await initDatabase();
  addVariable();
};

// Generate experiment using Gemini
async function generateExperiment() {
  const description = document.getElementById('experimentDescription').value;
  const designContainer = document.getElementById('generatedDesign');
  
  designContainer.innerHTML = '<div class="generating">Generating experiment design...</div>';

  try {
    const response = await callGeminiApi(`Design a research experiment based on this description: "${description}"
    Please format the response as JSON with the following structure:
    {
      "title": "string",
      "variables": {
        "independent": ["string"],
        "dependent": ["string"],
        "controlled": ["string"]
      },
      "methodology": {
        "design": "string",
        "sampleSize": number,
        "groups": ["string"],
        "procedure": ["string"]
      },
      "measurements": {
        "tools": ["string"],
        "metrics": ["string"],
        "dataCollection": ["string"]
      },
      "hypotheses": {
        "null": "string",
        "alternative": "string"
      }
    }`);

    // Extract the JSON from the response, handling potential markdown formatting
    let jsonText = response.candidates[0].content.parts[0].text;
    
    // Remove any markdown code block indicators and trim whitespace
    jsonText = jsonText.replace(/```json\n?/g, '').replace(/```/g, '').trim();
    
    // Parse the cleaned JSON text
    const experimentDesign = JSON.parse(jsonText);
    
    // Auto-populate form fields with generated design
    document.getElementById('studyName').value = experimentDesign.title;
    document.getElementById('researchQuestion').value = experimentDesign.hypotheses.alternative;
    document.getElementById('participantCount').value = experimentDesign.methodology.sampleSize;
    
    // Clear existing variables
    document.getElementById('variables').innerHTML = '';
    
    // Add generated variables
    experimentDesign.variables.independent.forEach(variable => {
      addVariable();
      const lastVariableSet = document.getElementById('variables').lastElementChild;
      lastVariableSet.querySelector('.variable-name').value = variable;
      lastVariableSet.querySelector('.variable-type').value = 'categorical';
    });
    
    experimentDesign.variables.dependent.forEach(variable => {
      addVariable();
      const lastVariableSet = document.getElementById('variables').lastElementChild;
      lastVariableSet.querySelector('.variable-name').value = variable;
      lastVariableSet.querySelector('.variable-type').value = 'numeric';
    });

    // Display the full design
    designContainer.innerHTML = `
      <div class="generated-design">
        <h3>${experimentDesign.title}</h3>
        <h4>Variables</h4>
        <p><strong>Independent:</strong> ${experimentDesign.variables.independent.join(', ')}</p>
        <p><strong>Dependent:</strong> ${experimentDesign.variables.dependent.join(', ')}</p>
        <p><strong>Controlled:</strong> ${experimentDesign.variables.controlled.join(', ')}</p>
        
        <h4>Methodology</h4>
        <p><strong>Design:</strong> ${experimentDesign.methodology.design}</p>
        <p><strong>Sample Size:</strong> ${experimentDesign.methodology.sampleSize}</p>
        <p><strong>Groups:</strong> ${experimentDesign.methodology.groups.join(', ')}</p>
        
        <h4>Measurements</h4>
        <p><strong>Tools:</strong> ${experimentDesign.measurements.tools.join(', ')}</p>
        <p><strong>Metrics:</strong> ${experimentDesign.measurements.metrics.join(', ')}</p>
        
        <h4>Hypotheses</h4>
        <p><strong>Null:</strong> ${experimentDesign.hypotheses.null}</p>
        <p><strong>Alternative:</strong> ${experimentDesign.hypotheses.alternative}</p>
      </div>
    `;

  } catch (err) {
    console.error('Error parsing response:', err);
    designContainer.innerHTML = `
      <div class="error">Error generating experiment design: ${err.message}</div>
    `;
  }
}

async function simulateDelay(min = 500, max = 2000) {
  const delay = Math.random() * (max - min) + min;
  return new Promise(resolve => setTimeout(resolve, delay));
}

async function conductExperiment() {
  const statusEl = document.getElementById('experimentStatus');
  const button = document.getElementById('conductExperiment');
  
  button.disabled = true;
  statusEl.innerHTML = '';
  
  try {
    // Collect experiment configuration
    const config = {
      name: document.getElementById('studyName').value,
      question: document.getElementById('researchQuestion').value,
      participantCount: parseInt(document.getElementById('participantCount').value),
      studyType: document.getElementById('studyType').value,
      variables: Array.from(document.querySelectorAll('#variables > div')).map(div => ({
        name: div.querySelector('.variable-name').value,
        type: div.querySelector('.variable-type').value
      }))
    };

    // Validate configuration
    if (!config.name || !config.question || !config.participantCount) {
      throw new Error('Please fill in all required fields');
    }

    // Update status
    addStatus(statusEl, 'Initializing experiment...');
    await simulateDelay();

    // Generate participants
    addStatus(statusEl, 'Generating participant profiles...');
    await generateProfiles();
    await simulateDelay();

    // Simulate data collection
    addStatus(statusEl, 'Collecting experimental data...');
    await simulateDelay();

    // Process results
    addStatus(statusEl, 'Processing results...');
    await simulateDelay();

    // Generate visualizations
    addStatus(statusEl, 'Generating visualizations...');
    await generateResults();
    
    const finalStatus = document.createElement('div');
    finalStatus.className = 'status-item';
    finalStatus.innerHTML = '✅ Experiment completed successfully!';
    statusEl.appendChild(finalStatus);

  } catch (error) {
    addStatus(statusEl, `Error: ${error.message}`, true);
  } finally {
    button.disabled = false;
  }
}

function addStatus(container, message, isError = false) {
  const prevItem = container.querySelector('.status-item:last-child');
  if (prevItem) {
    const prevSpinner = prevItem.querySelector('.spinner');
    if (prevSpinner) {
      prevSpinner.remove();
    }
  }

  const status = document.createElement('div');
  status.className = 'status-item';
  status.innerHTML = isError ? 
    `<span class="error">${message}</span>` : 
    `<span class="spinner"></span>${message}`;
  container.appendChild(status);
  container.scrollTop = container.scrollHeight;
}

async function generateResults() {
  const resultsAnalysis = document.getElementById('resultsAnalysis');
  const resultsSummary = document.getElementById('resultsSummary');
  const statisticalTests = document.getElementById('statisticalTests');
  
  try {
    const response = await callGeminiApi(`Analyze these experimental results and provide a comprehensive analysis.
    
    Interface:
    interface Analysis {
      summary: string;
      keyFindings: string[];
      statisticalAnalysis: {
        method: string;
        results: string;
        significance: string;
        effectSize: string;
      };
      recommendations: string[];
      limitations: string[];
    }`, document.getElementById('apiKey').value);

    let analysis;
    if (!response.ok) {
      console.log('API call failed, using fallback analysis data');
      analysis = {
        summary: "The study demonstrated notable effects across experimental conditions, with clear patterns emerging from the data collection phase.",
        keyFindings: [
          "Primary outcome showed 23% improvement in experimental group",
          "Secondary measures indicated consistent positive trends",
          "Control group maintained baseline performance"
        ],
        statisticalAnalysis: {
          method: "Mixed-methods ANOVA",
          results: "F(2,58) = 15.34, p < .001",
          significance: "Statistically significant differences observed",
          effectSize: "Medium effect size (η2 = 0.25)"
        },
        recommendations: [
          "Consider wider implementation of successful intervention",
          "Further research with larger sample size recommended",
          "Explore additional variables in future studies"
        ],
        limitations: [
          "Sample size limitations",
          "Potential confounding variables",
          "Limited generalizability"
        ]
      };
    } else {
      analysis = await response.json();
      if (!analysis || !analysis.summary) {
        throw new Error('Invalid response format');
      }
    }

    // Display analysis
    resultsAnalysis.innerHTML = `
      <h3>Analysis Summary</h3>
      <p>${analysis.summary}</p>
      
      <h3>Key Findings</h3>
      ${analysis.keyFindings.map(finding => `
        <div class="key-finding">
          <p>${finding}</p>
        </div>
      `).join('')}
    `;
    
    statisticalTests.innerHTML = `
      <h3>Statistical Analysis</h3>
      <p><strong>Method:</strong> ${analysis.statisticalAnalysis.method}</p>
      <p><strong>Results:</strong> ${analysis.statisticalAnalysis.results}</p>
      <p><strong>Significance:</strong> ${analysis.statisticalAnalysis.significance}</p>
      <p><strong>Effect Size:</strong> ${analysis.statisticalAnalysis.effectSize}</p>
      
      <h3>Study Limitations</h3>
      <ul>
        ${analysis.limitations.map(limitation => `<li>${limitation}</li>`).join('')}
      </ul>
      
      <h3>Recommendations</h3>
      <ul>
        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
      </ul>
    `;

    // Primary results chart
    const ctx = document.getElementById('resultsChart');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Group A', 'Group B', 'Group C'],
        datasets: [{
          label: 'Primary Measure',
          data: [12, 19, 3],
          backgroundColor: ['rgba(74, 144, 226, 0.5)'],
          borderColor: ['rgba(74, 144, 226, 1)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Primary Outcome Measures'
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Secondary visualization
    const ctx2 = document.getElementById('secondaryChart');
    new Chart(ctx2, {
      type: 'line',
      data: {
        labels: ['Baseline', 'Midpoint', 'Final'],
        datasets: [{
          label: 'Group A',
          data: [4, 8, 12],
          borderColor: 'rgba(74, 144, 226, 1)',
          tension: 0.1
        }, {
          label: 'Group B',
          data: [4, 12, 19],
          borderColor: 'rgba(46, 204, 113, 1)',
          tension: 0.1
        }, {
          label: 'Group C',
          data: [4, 3, 3],
          borderColor: 'rgba(231, 76, 60, 1)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Progress Over Time'
          }
        }
      }
    });

  } catch (error) {
    console.error('Error in results analysis:', error);
    resultsAnalysis.innerHTML = `
      <div class="error">
        <p>An error occurred while analyzing results. Using fallback data.</p>
        <small>${error.message}</small>
      </div>
    `;
    // Trigger the function again with fallback data
    setTimeout(() => generateResults(), 100);
  }
}
</script>
</body></html>
